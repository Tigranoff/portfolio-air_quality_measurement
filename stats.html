<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IoT Statistics - Air Quality</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    h1 { margin-bottom: 8px; }
    .metrics { display: grid; grid-template-columns: 1fr; gap: 12px; max-width: 1200px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
    .charts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
    .chart-container { background: #fff; border:1px solid #e0e0e0; border-radius: 6px; padding: 12px; }
    canvas { width: 100%; height: auto; }
    .note { color: #666; font-size: 14px; margin-top: 8px; }
    a.button { display:inline-block; margin-top:12px; padding:8px 12px; background:#24292e; color:#fff; text-decoration:none; border-radius:6px; }
    .button { background: #24292e; color: #fff; border: none; padding: 8px 12px; cursor: pointer; border-radius: 6px; }
    .data-controls { margin-bottom: 20px; }
    .url-load { display: flex; gap: 8px; }
    .url-load input { flex: 1; }
    .status { margin-top: 8px; font-size: 14px; color: #333; }
  </style>
</head>
<body>
  <a href="index.html" class="button">← Back</a>
  <h1>IoT Air Quality — Statistics</h1>

  <div class="metrics">
    <div id="summary">Loading...</div>

    <div class="charts">
      <div class="chart-container">
        <h3>Temperature (°C)</h3>
        <canvas id="tempChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>PM2.5 (µg/m³)</h3>
        <canvas id="pmChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Humidity (%)</h3>
        <canvas id="humChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Pressure (hPa)</h3>
        <canvas id="presChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>CO₂ (ppm)</h3>
        <canvas id="co2Chart"></canvas>
      </div>
      <div class="chart-container">
        <h3>PM10 (µg/m³)</h3>
        <canvas id="pm10Chart"></canvas>
      </div>
    </div>

    <section class="data-controls">
      <div class="url-load">
        <input id="data-url" type="text" placeholder="Paste JSON URL(s) — comma-separated" aria-label="JSON URL(s)">
        <button id="load-url">Load</button>
      </div>

      <div id="status" class="status" aria-live="polite"></div>
    </section>
  </div>

  <script>
    // Load JSON via fetch
    async function loadJSONFetch(path) {
      try {
        const r = await fetch(path);
        if (!r.ok) throw new Error('not found');
        return await r.json();
      } catch (e) {
        return null;
      }
    }

    // Read File object
    function readFileJSON(file) {
      return new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            resolve(parsed);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = () => reject(reader.error);
        reader.readAsText(file);
      });
    }

    function statsFor(values) {
      if (!values || !values.length) return null;
      const nums = values.filter(v => typeof v === 'number' && !isNaN(v));
      if (!nums.length) return null;
      const sum = nums.reduce((a,b)=>a+b,0);
      return {
        latest: +(nums[nums.length-1]).toFixed(2),
        min: +(Math.min(...nums)).toFixed(2),
        max: +(Math.max(...nums)).toFixed(2),
        avg: +(sum/nums.length).toFixed(2)
      };
    }

    function renderTable(stats) {
      const keys = Object.keys(stats);
      let html = '<table><thead><tr><th>Metric</th><th>Latest</th><th>Min</th><th>Max</th><th>Average</th></tr></thead><tbody>';
      keys.forEach(k=>{
        const s = stats[k];
        if (!s) {
          html += `<tr><td>${k}</td><td colspan="4">N/A</td></tr>`;
        } else {
          html += `<tr><td>${k}</td><td>${s.latest}</td><td>${s.min}</td><td>${s.max}</td><td>${s.avg}</td></tr>`;
        }
      });
      html += '</tbody></table>';
      document.getElementById('summary').innerHTML = html;
    }

    function drawLine(canvas, data, color='#0074D9') {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!data || !data.length) {
        ctx.fillStyle = '#999';
        ctx.font = '14px sans-serif';
        ctx.fillText('No data', 10, 20);
        return;
      }

      const w = canvas.width, h = canvas.height, pad = 20;
      const nums = data.filter(v => typeof v === 'number' && !isNaN(v));
      if (!nums.length) {
        ctx.fillStyle = '#999';
        ctx.font = '14px sans-serif';
        ctx.fillText('No data', 10, 20);
        return;
      }

      const max = Math.max(...nums);
      const min = Math.min(...nums);
      const range = (max - min) || 1;

      // Draw line
      ctx.beginPath();
      nums.forEach((v, i) => {
        const x = pad + i * ((w - pad * 2) / Math.max(1, nums.length - 1));
        const y = h - pad - ((v - min) / range) * (h - pad * 2);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.stroke();

      // Draw axis labels
      ctx.fillStyle = '#333';
      ctx.font = '12px sans-serif';
      ctx.textAlign = 'right';
      ctx.fillText(max.toFixed(1), w - 5, 15);
      ctx.fillText(min.toFixed(1), w - 5, h - 5);
    }

    function processReadings(readings) {
      if (!readings || !readings.length) {
        document.getElementById('summary').innerHTML = '<p>No readings found.</p>';
        return;
      }

      readings.sort((x, y) => new Date(x.timestamp) - new Date(y.timestamp));

      const temp = readings.map(r => Number(r.temperature));
      const press = readings.map(r => Number(r.pressure));
      const hum = readings.map(r => Number(r.humidity));
      const co2 = readings.map(r => Number(r.co2ppm));
      const pm25 = readings.map(r => Number(r.pm2_5));
      const pm10 = readings.map(r => Number(r.pm10));

      const stats = {
        "Temperature (°C)": statsFor(temp),
        "Pressure (hPa)": statsFor(press),
        "Humidity (%)": statsFor(hum),
        "CO₂ (ppm)": statsFor(co2),
        "PM2.5 (µg/m³)": statsFor(pm25),
        "PM10 (µg/m³)": statsFor(pm10)
      };

      renderTable(stats);

      // Draw all 6 charts
      drawLine(document.getElementById('tempChart'), temp, '#e96464');
      drawLine(document.getElementById('pmChart'), pm25, '#4a90e2');
      drawLine(document.getElementById('humChart'), hum, '#9966cc');
      drawLine(document.getElementById('presChart'), press, '#ff9900');
      drawLine(document.getElementById('co2Chart'), co2, '#666666');
      drawLine(document.getElementById('pm10Chart'), pm10, '#00aa55');
    }

    (async function() {
      // Try to fetch data
      const data = await loadJSONFetch('data_without_voc.json');
      
      if (data && Array.isArray(data.readings) && data.readings.length) {
        processReadings(data.readings);
        return;
      }

      // If fetch failed, show upload panel
      document.getElementById('summary').innerHTML = '<p>No data loaded via fetch. Use the upload panel below.</p>';

      // Wire upload buttons
      const fileAInput = document.getElementById('fileA');
      const loadBtn = document.getElementById('loadUploads');
      const clearBtn = document.getElementById('clearUploads');

      loadBtn.addEventListener('click', async () => {
        try {
          const fileA = fileAInput.files[0];
          const parsed = await readFileJSON(fileA);
          if (parsed && Array.isArray(parsed.readings)) {
            processReadings(parsed.readings);
          } else {
            alert('Invalid JSON format. Expected {readings: [...]}');
          }
        } catch (err) {
          alert('Error: ' + err.message);
        }
      });

      clearBtn.addEventListener('click', () => {
        fileAInput.value = '';
      });
    })();
  </script>
</body>
</html>